# Setting up headless display with NVIDIA

To set up VirtualGL we need to create X11 config files first.

Run `nvidia-xconfig --query-gpu-info` to find the PCI bus values for the three GPU. Select the first GPU (Device 0) as the one we want to run the X11 display on.

Create the `xorg.conf` file with the PCI bus number: 

```
sudo nvidia-xconfig -a --allow-empty-initial-configuration --enable-all-gpus --use-display-device=none --virtual=1920x981 -o /etc/X11/xorg.conf --busid={busid of GPU 0}
```

### Edit /etc/X11/xorg.conf 

Add the following at the top of the file

```
Section "DRI"
        Mode 0666
EndSection
```

Check the correct BusID in the Device part for all GPUs (make sure not all the same)

```
Section "Device"
        Identifier "Device0"
        Driver "nvidia"
        VendorName "NVIDIA Corporation"
        BusID "PCI:X:X:0"
EndSection
```

Remove the Option in the `Screen` section:

```
Option "UseDisplayDevice" "none"
```

Add into the `Screen` section for the first GPU: 

```Option "HardDPMS" "false"```

### Troubleshooting

#### Stop gdm Window Manager


```sudo service gdm stop``` 
or
```sudo service gdm3 stop```

#### Maybe also stop lightdm

```sudo service lightdm stop```

#### Edit xinit permissions

```sudo sed -i -e "s/console/anybody/" /etc/X11/Xwrapper.config```

### Start the X Server

```export DISPLAY=:0```

```xinit &```

This should return you back to the CLI, if it holds the terminal it might be errored. 

### Test that it is working:

Check if Xorg is using nvidia driver under processes

```nvidia-smi```

### Check OpenGL:

```
glxinfo | grep OpenGL
```

If everything is ok there should be something with "NVIDIA OpenGL EGL"



### /etc/X11/xorg.conf

This is the functional version on my Ubuntu 18.04 machine:

```
# nvidia-xconfig: X configuration file generated by nvidia-xconfig
# nvidia-xconfig:  version 450.51.06


Section "ServerLayout"
    Identifier     "Layout0"
    Screen      0  "Screen0"
    Screen      1  "Screen1" RightOf "Screen0"
    InputDevice    "Keyboard0" "CoreKeyboard"
    InputDevice    "Mouse0" "CorePointer"
EndSection

Section "Files"
EndSection

Section "InputDevice"

    # generated from default
    Identifier     "Mouse0"
    Driver         "mouse"
    Option         "Protocol" "auto"
    Option         "Device" "/dev/psaux"
    Option         "Emulate3Buttons" "no"
    Option         "ZAxisMapping" "4 5"
EndSection

Section "InputDevice"

    # generated from default
    Identifier     "Keyboard0"
    Driver         "kbd"
EndSection

Section "Monitor"
    Identifier     "Monitor0"
    VendorName     "Unknown"
    ModelName      "Unknown"
    Option         "DPMS"
EndSection

Section "Monitor"
    Identifier     "Monitor1"
    VendorName     "Unknown"
    ModelName      "Unknown"
    Option         "DPMS"
EndSection

Section "Device"
    Identifier     "Device0"
    Driver         "nvidia"
    VendorName     "NVIDIA Corporation"
    BoardName      "GeForce GTX 1080"
    BusID          "PCI:2:0:0"
EndSection

Section "Device"
    Identifier     "Device1"
    Driver         "nvidia"
    VendorName     "NVIDIA Corporation"
    BoardName      "GeForce GTX 1080"
    BusID          "PCI:2:0:0"
EndSection

Section "Screen"
    Identifier     "Screen0"
    Device         "Device0"
    Monitor        "Monitor0"
    DefaultDepth    24
    Option         "AllowEmptyInitialConfiguration" "True"
    Option         "HardDPMS" "false"
    SubSection     "Display"
        Virtual     1920 981
        Depth       24
    EndSubSection
EndSection

Section "Screen"
    Identifier     "Screen1"
    Device         "Device1"
    Monitor        "Monitor1"
    DefaultDepth    24
    Option         "AllowEmptyInitialConfiguration" "True"
    Option          "HardDPMS" "false"
    SubSection     "Display"
        Virtual     1920 981
        Depth       24
    EndSubSection
EndSection

``
